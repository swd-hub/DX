<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Data Viewer - Card Database</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --sidebar-width: 380px;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            overflow: hidden;
            display: flex;
        }

        /* Êìç‰Ωú„Éë„Éç„É´Ôºà„Éâ„É≠„ÉØ„ÉºÔºâ */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: #fff;
            border-right: 1px solid var(--border);
            position: fixed;
            left: calc(-1 * var(--sidebar-width));
            top: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            padding: 30px 20px;
            box-sizing: border-box;
            overflow-y: auto;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
        }

        #sidebar.open {
            transform: translateX(var(--sidebar-width));
        }

        /* „É°„Ç§„É≥„Ç®„É™„Ç¢ */
        #main-content {
            flex: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            padding: 40px;
            box-sizing: border-box;
        }

        /* „Éà„Ç∞„É´„Éú„Çø„É≥ */
        .toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background: var(--text-main);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Â∑®Â§ßÂåñ„Åó„Åü„Ç´„Éº„Éâ */
        .db-card {
            background: var(--card);
            width: 100%;
            max-width: 1000px;
            height: 85vh;
            padding: 60px;
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border-top: 15px solid var(--primary);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .card-header {
            border-bottom: 4px solid var(--bg);
            margin-bottom: 40px;
            padding-bottom: 15px;
        }

        .card-header h1 {
            font-size: 3rem;
            margin: 0;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        .card-body {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .card-field {
            background: #fdfdfd;
            border: 1px solid #f1f5f9;
            padding: 20px;
            border-radius: 16px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }

        .card-field:hover {
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        .card-field.dragging {
            opacity: 0.6;
        }

        .card-field .card-field-handle {
            cursor: grab;
            color: #94a3b8;
            font-size: 1rem;
            user-select: none;
            margin-bottom: 8px;
        }

        .card-field .card-field-handle:active {
            cursor: grabbing;
        }

        .field-label {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: 0.05em;
        }

        .field-value {
            font-size: 1.3rem;
            line-height: 1.4;
            color: #1e293b;
            font-weight: 500;
            word-break: break-word;
            flex-grow: 1;
        }

        .field-date {
            font-size: 1.1rem;
            color: #4f46e5;
            margin-top: 12px;
            font-family: monospace;
            font-weight: 600;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .field-age {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 4px;
            font-weight: 500;
        }

        /* „Éö„Éº„Ç∏Êìç‰Ωú */
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 35px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: rgba(79, 70, 229, 0.08);
        }

        /* Ë®≠ÂÆöÈ†ÖÁõÆ */
        textarea {
            width: 100%;
            height: 120px;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 2px dashed var(--border);
            padding: 15px;
            font-size: 0.85rem;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
            user-select: text;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .setting-section {
            margin-bottom: 30px;
        }

        .setting-section h3 {
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 800;
        }

        input[type="text"],
        input[type="date"] {
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        label {
            cursor: pointer;
            user-select: none;
        }

        input[type="checkbox"] {
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        .card-body::-webkit-scrollbar {
            width: 8px;
        }

        .card-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .card-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .card-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        #sidebar::-webkit-scrollbar {
            width: 6px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Á©∫Áä∂ÊÖã„É°„ÉÉ„Çª„Éº„Ç∏ */
        .empty-state {
            text-align: center;
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ===== „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπË®≠ÂÆöÈ†ÖÁõÆ„Çπ„Çø„Ç§„É´ ===== */
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .setting-item:hover {
            background: #f1f5f9;
            border-color: var(--primary);
        }

        .setting-item input[type="checkbox"] {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .setting-item label {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-main);
            font-weight: 500;
            margin: 0;
            cursor: pointer;
        }

        /* „Éò„ÉÉ„ÉÄË®≠ÂÆö„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
        #headerSettings {
            max-height: 350px;
            overflow-y: auto;
        }

        .header-setting-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .header-setting-item:hover {
            background: #f1f5f9;
            border-color: var(--border);
        }

        .header-setting-item input[type="checkbox"] {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        .header-setting-item input[type="text"] {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
            box-sizing: border-box;
        }

        .header-setting-item input[type="text"]:focus {
            border-color: var(--primary);
            outline: none;
        }

        .birthdate-group {
            margin-bottom: 16px;
        }

        .age-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin-bottom: 0;
            background: #ffffff;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
        }

        .age-checkbox input[type="checkbox"] {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .age-checkbox label {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-main);
            font-weight: 500;
            margin: 0;
            cursor: pointer;
        }

        /* „Éó„É™„É≥„ÉàÂØæÂøú */
        @media print {

            .toggle-btn,
            #sidebar,
            .nav-controls {
                display: none !important;
            }

            #main-content {
                padding: 0;
            }

            .db-card {
                width: 100%;
                height: auto;
                max-width: 100%;
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: avoid;
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
            }

            .db-card {
                padding: 40px 30px;
                height: auto;
                min-height: 80vh;
            }

            .card-header h1 {
                font-size: 2rem;
            }

            .card-body {
                grid-template-columns: 1fr;
            }

            .nav-controls {
                flex-wrap: wrap;
                gap: 20px;
                justify-content: center;
            }
        }
    </style>
</head>

<body>

    <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞ Ë®≠ÂÆö</button>

    <div id="sidebar">
        <h2 style="margin-top: 40px; font-size: 1.5rem; color: var(--text-main);">Ë®≠ÂÆö„Éë„Éç„É´</h2>

        <div class="setting-section">
            <h3>1Ô∏è‚É£ indexDATABASE</h3>
            <p style="font-size: 0.75rem; color: #64748b; margin: 0 0 10px 0;">CSV„ÇíË≤º„Çä‰ªò„Åë„Çã„Åã„ÄÅ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„Éï„Ç°„Ç§„É´ÈÅ∏Êäû</p>
            <label for="indexDATABASE"
                style="font-size: 0.75rem; color: var(--primary); font-weight: 700;">indexDATABASE</label>
            <textarea id="indexDATABASE" ondblclick="document.getElementById('fileHidden').click()"
                oninput="processData()" placeholder="Âπ¥ÊúàÊó•,ÂêçÂâç,È†ÖÁõÆ,ÂÜÖÂÆπ&#10;„ÅÆÂΩ¢Âºè„ÅßCSV„ÇíË≤º„Çä‰ªò„Åë"></textarea>
            <input type="file" id="fileHidden" style="display:none" accept=".csv,.txt" onchange="handleFile(event)">

            <div class="setting-item">
                <input type="checkbox" id="enableDedup" checked onchange="processData()">
                <label for="enableDedup">ÂêÑÈ†ÖÁõÆ„ÅÆÊúÄÁµÇÊõ¥Êñ∞Êó•„Éá„Éº„Çø„ÅÆ„ÅøÊäΩÂá∫</label>
            </div>
        </div>

        <div class="setting-section">
            <h3>2Ô∏è‚É£ Áµû„ÇäËæº„ÅøÊù°‰ª∂</h3>
            <input type="text" id="globalSearch"
                style="width:100%; padding:12px; margin-bottom:10px; border:1px solid var(--border); border-radius:8px; box-sizing: border-box;"
                placeholder="ÂêçÂâç„ÇíÊ§úÁ¥¢..." oninput="renderView()">
            <p style="font-size: 0.75rem; margin: 10px 0 5px 0; color: #64748b;">Âü∫Ê∫ñÊó•‰ª•Èôç„ÅÆË®òÈå≤„Åå„ÅÇ„ÇãÂØæË±°„ÅÆ„ÅøË°®Á§∫:</p>
            <input type="date" id="dateFilter"
                style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; box-sizing: border-box;"
                onchange="renderView()">
        </div>

        <div class="setting-section">
            <h3>3Ô∏è‚É£ Ë°®Á§∫È†ÖÁõÆ„ÅÆË®≠ÂÆö</h3>
            <p style="font-size: 0.75rem; color: #64748b; margin: 0 0 8px 0;">Ë°®Á§∫ÁîªÈù¢„ÅÆ„Ç´„Éº„Éâ‰∏ä„Åß„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà„Éª‰∏¶„Å≥„ÅØËá™Âãï‰øùÂ≠ò</p>
            <div id="headerSettings"></div>
            <button type="button" class="btn btn-outline" id="btnResetOrder" onclick="resetColumnOrder()"
                style="margin-top:10px; display:none;">‰∏¶„Å≥„ÇíËß£Èô§</button>
        </div>

        <div class="setting-section" style="border-top: 2px solid var(--border); padding-top: 20px;">
            <p style="font-size: 0.75rem; color: #94a3b8; margin: 0;">
                <strong id="statsRecords">0</strong> ‰ª∂„ÅÆ„É¨„Ç≥„Éº„ÉâË™≠ËæºÊ∏à„Åø<br>
                <strong id="statsPeople">0</strong> Âêç„ÅÆ‰∫∫Áâ©<br>
                <strong id="statsItems">0</strong> ÂÄã„ÅÆÈ†ÖÁõÆ
            </p>
        </div>
    </div>

    <div id="main-content">
        <div id="cardView" style="width: 100%; display: flex; justify-content: center; align-items: center;">
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <p>CSV„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
            </div>
        </div>

        <div class="nav-controls">
            <button class="btn btn-primary" onclick="changePage(-1)">‚óÄ PREV</button>
            <span id="pageInfo"
                style="font-size: 1.5rem; font-weight: 800; font-family: 'Courier New', Courier, monospace; min-width: 100px; text-align: center;">0
                / 0</span>
            <button class="btn btn-primary" onclick="changePage(1)">NEXT ‚ñ∂</button>
        </div>
    </div>

    <script>
        // ===== State Management =====
        const COLUMN_ORDER_KEY = 'dataViewer_indexDATABASE_columnOrder';
        let rawRecords = [];
        let headerConfigs = [];
        let currentIndex = 0;
        let filteredPeople = [];
        let ageShowFlags = {};
        let draggedIndex = null;

        const BIRTHDATE_KEYWORDS = ['ÁîüÂπ¥ÊúàÊó•', 'ÁîüÂπ¥Êúà', 'ÁîüÂπ¥', 'birthdate', 'birth'];

        function saveColumnOrder() {
            if (headerConfigs.length === 0) return;
            try {
                localStorage.setItem(COLUMN_ORDER_KEY, JSON.stringify(headerConfigs.map(c => c.raw)));
                document.getElementById('btnResetOrder').style.display = '';
            } catch (e) { }
        }

        function loadColumnOrder() {
            try {
                const s = localStorage.getItem(COLUMN_ORDER_KEY);
                return s ? JSON.parse(s) : null;
            } catch (e) { return null; }
        }

        function resetColumnOrder() {
            try { localStorage.removeItem(COLUMN_ORDER_KEY); } catch (e) { }
            document.getElementById('btnResetOrder').style.display = 'none';
            if (headerConfigs.length === 0) return;
            const sorted = [...headerConfigs].sort((a, b) => (a.raw || '').localeCompare(b.raw || ''));
            headerConfigs.length = 0;
            headerConfigs.push(...sorted);
            renderHeaderSettings();
            renderView();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            if (document.getElementById('sidebar').classList.contains('open')) {
                document.addEventListener('click', closeSidebarOnClickOutside);
            } else {
                document.removeEventListener('click', closeSidebarOnClickOutside);
            }
        }

        function closeSidebarOnClickOutside(e) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.toggle-btn');
            if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                sidebar.classList.remove('open');
                document.removeEventListener('click', closeSidebarOnClickOutside);
            }
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('indexDATABASE').value = event.target.result;
                processData();
            };
            reader.onerror = () => {
                alert('„Éï„Ç°„Ç§„É´Ë™≠Ëæº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseDate(dateStr) {
            const wareki = {
                'S': 1926, 'H': 1989, 'R': 2019
            };

            let normalized = dateStr.trim();

            // ÂíåÊö¶„Éë„Çø„Éº„É≥
            const warekiMatch = normalized.match(/^([SHR])(\d+)\.(\d+)\.(\d+)$/);
            if (warekiMatch) {
                const [, era, year, month, day] = warekiMatch;
                const baseYear = wareki[era];
                const yyyy = baseYear + parseInt(year);
                normalized = `${yyyy}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }

            normalized = normalized.replace(/\//g, '-');

            const date = new Date(normalized);
            return {
                str: normalized,
                ts: isNaN(date.getTime()) ? 0 : date.getTime(),
                valid: !isNaN(date.getTime()),
                date: date
            };
        }

        function calculateAge(birthDateStr) {
            const birthDate = parseDate(birthDateStr);

            if (!birthDate.valid) {
                return null;
            }

            const today = new Date();
            const birth = birthDate.date;

            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            return age >= 0 ? age : null;
        }

        function isBirthdateField(itemName) {
            const lower = itemName.toLowerCase();
            return BIRTHDATE_KEYWORDS.some(keyword => lower.includes(keyword));
        }

        function processData() {
            const text = document.getElementById('indexDATABASE').value.trim();
            if (!text) {
                rawRecords = [];
                headerConfigs = [];
                ageShowFlags = {};
                updateStats();
                renderView();
                return;
            }

            const allParsed = text.split('\n')
                .filter(l => l.trim() !== '' && !l.trim().startsWith('#'))
                .map(line => {
                    const cols = line.split(/,/).map(s => s.trim().replace(/^"|"$/g, ''));
                    const dateInfo = parseDate(cols[0]);

                    return {
                        dateStr: dateInfo.str,
                        ts: dateInfo.ts,
                        valid: dateInfo.valid,
                        name: cols[1] || '',
                        item: cols[2] || '',
                        content: cols[3] || ''
                    };
                })
                .filter(r => r.valid && r.name && r.item)
                .sort((a, b) => b.ts - a.ts);

            const isFinalOnly = document.getElementById('enableDedup').checked;
            const allItems = new Set();

            if (isFinalOnly) {
                const seen = new Map();
                rawRecords = [];

                allParsed.forEach(r => {
                    const key = `${r.name}|${r.item}`;
                    if (!seen.has(key)) {
                        seen.set(key, r);
                        rawRecords.push(r);
                    }
                    allItems.add(r.item);
                });
            } else {
                rawRecords = allParsed;
                allParsed.forEach(r => allItems.add(r.item));
            }

            if (headerConfigs.length === 0 || headerConfigs.length !== allItems.size) {
                const defaultOrder = Array.from(allItems).sort();
                const savedOrder = loadColumnOrder();
                let order = defaultOrder;
                if (savedOrder && savedOrder.length) {
                    const inSaved = savedOrder.filter(r => allItems.has(r));
                    const newOnes = defaultOrder.filter(x => !inSaved.includes(x));
                    order = [...inSaved, ...newOnes];
                }
                headerConfigs = order.map(item => ({
                    raw: item,
                    alias: item,
                    active: true
                }));
                ageShowFlags = {};
                Array.from(allItems).forEach(item => {
                    if (isBirthdateField(item)) ageShowFlags[item] = true;
                });
            }

            currentIndex = 0;
            updateStats();
            renderHeaderSettings();
            renderView();

            // Debounce save to IndexedDB
            if (window.saveTimeout) clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(() => {
                saveDataToDB(text);
            }, 500);
        }

        // ===== IndexedDB Persistence =====
        const DB_NAME = 'DataViewerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'settings';
        const DATA_KEY = 'csvData';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }

        async function saveDataToDB(data) {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(data, DATA_KEY);
            } catch (e) {
                console.error('Failed to save data:', e);
            }
        }

        async function loadDataFromDB() {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(DATA_KEY);

                request.onsuccess = () => {
                    if (request.result) {
                        document.getElementById('indexDATABASE').value = request.result;
                        processData();
                    }
                };
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        }

        function updateStats() {
            const uniquePeople = new Set(rawRecords.map(r => r.name));
            const uniqueItems = new Set(rawRecords.map(r => r.item));

            document.getElementById('statsRecords').textContent = rawRecords.length;
            document.getElementById('statsPeople').textContent = uniquePeople.size;
            document.getElementById('statsItems').textContent = uniqueItems.size;
        }

        function renderHeaderSettings() {
            const container = document.getElementById('headerSettings');

            if (headerConfigs.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; font-size: 0.85rem;">„Åæ„Åö„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }

            container.innerHTML = headerConfigs.map((config, i) => {
                let inner = `
            <div class="header-setting-item">
                <input type="checkbox" ${config.active ? 'checked' : ''} onchange="headerConfigs[${i}].active = this.checked; renderView()">
                <input type="text" value="${escapeHtml(config.alias)}" oninput="headerConfigs[${i}].alias = this.value; renderView()">
            </div>
        `;
                if (isBirthdateField(config.raw)) {
                    const isChecked = ageShowFlags[config.raw] ? 'checked' : '';
                    inner = `
                <div class="birthdate-group">
                    <div class="header-setting-item">
                        <input type="checkbox" ${config.active ? 'checked' : ''} onchange="headerConfigs[${i}].active = this.checked; renderView()">
                        <input type="text" value="${escapeHtml(config.alias)}" oninput="headerConfigs[${i}].alias = this.value; renderView()">
                    </div>
                    <div class="age-checkbox">
                        <input type="checkbox" ${isChecked} onchange="toggleAgeDisplay('${config.raw}')">
                        <label>Âπ¥ÈΩ¢„ÇíË®àÁÆó„Åó„Å¶Ë°®Á§∫</label>
                    </div>
                </div>
            `;
                }
                return inner;
            }).join('');
        }

        function toggleAgeDisplay(itemName) {
            ageShowFlags[itemName] = !ageShowFlags[itemName];
            renderView();
        }

        function getFilteredPeople() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const dateLimit = document.getElementById('dateFilter').value;
            const dateLimitTs = dateLimit ? new Date(dateLimit).getTime() : 0;

            const grouped = {};
            rawRecords.forEach(record => {
                if (!grouped[record.name]) {
                    grouped[record.name] = {
                        name: record.name,
                        records: {},
                        maxTs: 0
                    };
                }

                const key = record.item;
                if (!grouped[record.name].records[key] || record.ts > grouped[record.name].records[key].ts) {
                    grouped[record.name].records[key] = record;
                }

                if (record.ts > grouped[record.name].maxTs) {
                    grouped[record.name].maxTs = record.ts;
                }
            });

            return Object.values(grouped)
                .filter(person => {
                    const matchesSearch = person.name.toLowerCase().includes(searchTerm);
                    const matchesDate = person.maxTs >= dateLimitTs;
                    return matchesSearch && matchesDate;
                })
                .sort((a, b) => b.maxTs - a.maxTs);
        }

        // ===== Rendering =====
        function renderView() {
            filteredPeople = getFilteredPeople();
            const container = document.getElementById('cardView');
            const pageInfo = document.getElementById('pageInfo');

            if (filteredPeople.length === 0) {
                container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <p>Êù°‰ª∂„Å´ÂêàËá¥„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>
        `;
                pageInfo.textContent = '0 / 0';
                return;
            }

            if (currentIndex >= filteredPeople.length) {
                currentIndex = 0;
            }

            const person = filteredPeople[currentIndex];
            renderCard(person, container);
            pageInfo.textContent = `${currentIndex + 1} / ${filteredPeople.length}`;
        }

        function renderCard(person, container) {
            const activeWithIndex = headerConfigs
                .map((config, idx) => ({ config, headerIndex: idx }))
                .filter(({ config }) => config.active);

            const fieldsHtml = activeWithIndex.map(({ config, headerIndex }) => {
                const record = person.records[config.raw];
                const displayValue = record ? record.content : '-';
                const displayDate = record ? record.dateStr : 'N/A';
                let ageHtml = '';
                if (ageShowFlags[config.raw] && isBirthdateField(config.raw) && record && record.content) {
                    const age = calculateAge(record.content);
                    if (age !== null) ageHtml = `<div class="field-age">Âπ¥ÈΩ¢: ${age}Êâç</div>`;
                }
                return `
            <div class="card-field" draggable="true" data-header-index="${headerIndex}" title="„Éâ„É©„ÉÉ„Ç∞„Åß‰∏¶„Å≥Êõø„Åà">
                <div class="card-field-handle">‚ãÆ‚ãÆ</div>
                <div class="field-label">${escapeHtml(config.alias)}</div>
                <div class="field-value">${escapeHtml(displayValue)}</div>
                <div class="field-date">üìÖ ${escapeHtml(displayDate)}</div>
                ${ageHtml}
            </div>
        `;
            }).join('');

            const emptyMessage = activeWithIndex.length === 0
                ? '<div class="empty-state"><p>Ë°®Á§∫„Åô„ÇãÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p></div>'
                : '';

            container.innerHTML = `
        <div class="db-card">
            <div class="card-header">
                <div style="font-size:0.9rem; color:var(--primary); font-weight:800;">PRIMARY KEY</div>
                <h1>${escapeHtml(person.name)}</h1>
            </div>
            <div class="card-body">
                ${fieldsHtml || emptyMessage}
            </div>
        </div>
    `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function changePage(step) {
            if (filteredPeople.length === 0) return;

            currentIndex = (currentIndex + step + filteredPeople.length) % filteredPeople.length;
            renderView();
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') changePage(-1);
            if (e.key === 'ArrowRight') changePage(1);
        });

        function setupDragDrop() {
            const el = document.getElementById('cardView');
            if (!el) return;
            el.addEventListener('dragstart', e => {
                const field = e.target.closest('.card-field');
                if (!field) return;
                draggedIndex = parseInt(field.getAttribute('data-header-index'), 10);
                field.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', String(draggedIndex));
            });
            el.addEventListener('dragend', e => {
                const field = e.target.closest('.card-field');
                if (field) field.classList.remove('dragging');
                draggedIndex = null;
            });
            el.addEventListener('dragover', e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            el.addEventListener('drop', e => {
                e.preventDefault();
                const field = e.target.closest('.card-field');
                if (!field || draggedIndex === null) return;
                let toIndex = parseInt(field.getAttribute('data-header-index'), 10);
                if (toIndex === draggedIndex) return;
                const moved = headerConfigs.splice(draggedIndex, 1)[0];
                if (draggedIndex < toIndex) toIndex--;
                headerConfigs.splice(toIndex, 0, moved);
                saveColumnOrder();
                renderHeaderSettings();
                renderView();
            });
        }

        window.addEventListener('load', () => {
            updateStats();
            renderHeaderSettings();
            renderView();
            setupDragDrop();
            if (loadColumnOrder()) document.getElementById('btnResetOrder').style.display = '';

            // Load persisted data
            loadDataFromDB();
        });
    </script>

</body>

</html>