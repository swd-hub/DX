<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ãƒ‡ã‚¸ã‚¿ãƒ«ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆï¼¤ï¼¸ï¼‰æ¨é€²ã€€é›†è¨ˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f1f5f9;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: auto;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h3 {
            border-left: 5px solid var(--primary);
            padding-left: 15px;
            font-size: 1.1rem;
            margin-top: 0;
        }

        textarea {
            width: 100%;
            height: 120px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        .config-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            overflow-y: auto;
            max-height: 400px;
            padding-bottom: 10px;
        }

        .header-item-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            width: 280px;
            flex-shrink: 0;
        }

        .header-item-card.name-card {
            border: 2px solid var(--primary);
            background: #eff6ff;
        }

        .source-name {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #1e40af;
            font-weight: 500;
            word-break: break-word;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .input-row label {
            font-size: 0.8rem;
            color: #666;
            font-weight: bold;
        }

        .input-row input {
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .column-filters {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            margin-top: 8px;
            border-top: 1px dotted #ccc;
            padding-top: 8px;
        }

        .column-filters div {
            display: flex;
            flex-direction: column;
            font-size: 0.7rem;
        }

        .column-filters input {
            padding: 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.75rem;
            width: 100%;
            box-sizing: border-box;
        }

        .mode-radio {
            font-size: 0.8rem;
            display: flex;
            justify-content: space-around;
            background: #fff;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .mode-radio label {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .mode-radio input {
            margin: 0;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 8px 6px;
            text-align: center;
            word-wrap: break-word;
            position: relative;
            font-size: 0.9rem;
        }

        th {
            background: #f8fafc;
            font-weight: bold;
            user-select: none;
            cursor: grab;
        }

        th:active {
            cursor: grabbing;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        th.dragging-col {
            opacity: 0.4;
            background: #e2e8f0;
        }

        th.drag-over {
            border-left: 3px solid var(--primary);
        }

        /* åˆ—å¹…ãƒªã‚µã‚¤ã‚¶ãƒ¼ */
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 6px;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            cursor: col-resize;
            user-select: none;
            z-index: 10;
        }

        .resizer:hover,
        .resizer.dragging {
            background: var(--primary);
        }

        .preview-title {
            text-align: center;
            font-size: 1.6rem;
            margin: 20px 0;
            font-weight: bold;
        }

        .btn-group {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .font-size-control label {
            font-weight: bold;
            font-size: 0.9rem;
            margin: 0;
        }

        .font-size-control input[type="range"] {
            width: 150px;
            height: 6px;
            cursor: pointer;
        }

        .font-size-display {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .data-text-preview {
            margin-top: 15px;
            background: #eee;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .data-text-preview textarea {
            height: 100px;
            background: #fff;
            cursor: text;
        }

        .raw-data-preview {
            margin-top: 10px;
            display: none;
        }

        .raw-data-preview textarea {
            height: 150px;
            background: #fafafa;
            border: 1px solid #ccc;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .config-save-area {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        #configFileInput {
            display: none;
        }

        #printStyles {
            display: none;
        }

        @media print {

            .no-print,
            .btn-group,
            textarea,
            .config-grid,
            .stats-grid,
            .data-text-preview,
            .raw-data-preview,
            #panelArea {
                display: none !important;
            }

            body,
            .container,
            .card {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
            }

            @page {
                margin: 15mm;
            }

            table {
                page-break-inside: avoid;
                width: 100%;
                border-collapse: collapse !important;
                border: 2px solid #000 !important;
            }

            thead {
                display: table-header-group;
            }

            tr {
                page-break-inside: avoid;
            }

            .preview-title {
                page-break-after: avoid;
                font-size: 1.4rem;
                margin-top: 0;
                margin-bottom: 5mm;
            }

            th,
            td {
                padding: 4px 3px;
                font-size: 0.85rem;
                border: 1px solid #000 !important;
            }

            .resizer {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <h1 class="no-print" style="text-align: center; color: #4f46e5; margin-bottom: 30px;">
        ğŸ“Š è³‡æ–™ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆDXæ¨é€²ï¼‰
    </h1>

    <div class="container">
        <div class="card no-print" style="margin-bottom: 10px; padding: 12px;" id="toggleBar">
            <button type="button" class="btn btn-primary" id="togglePanelBtn" onclick="togglePanelVisibility()">â–¼
                æ“ä½œãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º</button>
            <button type="button" class="btn btn-sm" style="background: #64748b; color: white; margin-left: 8px;"
                onclick="clearIndexedDB()" title="ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">ğŸ—‘ è‡ªå‹•èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="panelArea">
            <div class="card no-print">
                <h3>1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</h3>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">
                    æ å†…ã‚’<strong>ã€Œãƒã‚¦ã‚¹ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã€</strong>ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
                <textarea id="csvInput" ondblclick="document.getElementById('fileHidden').click()"
                    oninput="processData()" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
                <input type="file" id="fileHidden" style="display:none" accept=".csv" onchange="handleFile(event)">

                <div id="statsPanel" style="margin-top:20px; display:none;">
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">å…¥åŠ›ç·è¡Œæ•°</span><span id="statTotal"
                                class="stat-value">0</span></div>
                        <div class="stat-item"><span class="stat-label">å®Œå…¨é‡è¤‡æ’é™¤</span><span id="statFullDup"
                                class="stat-value">0</span></div>
                        <div class="stat-item"><span class="stat-label">æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿</span><span id="statUnique"
                                class="stat-value">0</span></div>
                        <div class="stat-item" style="border-color: #10b981;"><span class="stat-label">æŠ½å‡ºä»¶æ•°</span><span
                                id="statFiltered" class="stat-value">0</span>
                        </div>
                        <div class="stat-item" style="border-color: var(--primary);"><span
                                class="stat-label">ä»Šã®è¡¨ã®ã‚µã‚¤ã‚º</span><span id="statTableDim" class="stat-value">0 Ã— 0</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px; text-align: right;">
                        <button class="btn btn-sm btn-info" onclick="toggleRawJsonPreview()">ğŸ“„
                            åå‰ã”ã¨ã«æ•´ç†ã—ãŸJSONå½¢å¼ã§ç¢ºèª</button>
                    </div>

                    <div id="rawJsonPreviewArea" class="raw-data-preview">
                        <strong>å¤‰æ›ç›´å¾Œã®JSONï¼ˆåå‰ã”ã¨ã«æ•´ç†ï¼‰ï¼š</strong>
                        <textarea id="rawJsonOutput" readonly></textarea>
                    </div>

                    <div
                        style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                        <label style="font-weight: bold; cursor: pointer; display: inline-block; margin-right: 25px;">
                            <input type="checkbox" id="enableDedup" checked onchange="processData()">
                            åŒã˜åå‰ãƒ»é …ç›®ãƒ»å†…å®¹ã®ãƒ‡ãƒ¼ã‚¿ãŒè¤‡æ•°å¹´æœˆæ—¥ã‚ã‚‹å ´åˆã€æœ€ã‚‚å¤ã„æ—¥ä»˜ã®ã¿æ®‹ã™ï¼ˆãƒã‚§ãƒƒã‚¯æ™‚ï¼‰
                        </label>
                        <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                            â€» ãƒã‚§ãƒƒã‚¯ OFF ã«ã™ã‚‹ã¨ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã€ã€Œé »åº¦ã€ã‚’ã‚«ã‚¦ãƒ³ãƒˆã§ãã¾ã™
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9rem; color: #334155;">
                            <strong>è¡¨ç¤ºåˆ¤å®šã®åŸºæº–ï¼š</strong><br>
                            åŸºæº–æ—¥: <input type="date" id="latestDateLimit" onchange="renderTable()"
                                style="padding: 5px; margin-bottom: 5px;">
                            <button type="button" class="btn btn-sm btn-info" onclick="setToToday()"
                                style="padding: 2px 8px; margin-left: 5px; vertical-align: middle;">ä»Šæ—¥ã®æ—¥ä»˜</button>
                            <br>
                            æ–°è¦å°±è¾²æ—¥ãŒãªã„å ´åˆã®é¡ã‚Šå¹´æ•°(X): <input type="number" id="backwardYearsZ" value="4" min="1"
                                onchange="renderTable()" style="padding: 5px; width: 60px;"> å¹´
                            <div style="margin-top: 8px; font-size: 0.8rem; color: #666; line-height: 1.4;">
                                â€»ã€Œé’å¹´ç­‰å°±è¾²è¨ˆç”»æ¨é€²ä¼šè­°ã€ã®ã€Œæ–°è¦å°±è¾²ã€ãŒã‚ã‚‹å ´åˆã¯èªå®šæ—¥ãŒåŸºæº–æ—¥ã‚ˆã‚Šé’å¹´ç­‰å°±è¾²è¨ˆç”»æœŸé–“ã®5å¹´ä»¥å†…ã€<br>
                                ã€€ç„¡ã„å ´åˆã¯æœ€ã‚‚æ–°ã—ã„è¨˜éŒ²ãŒåŸºæº–æ—¥ã‚ˆã‚ŠXå¹´ä»¥å†…(åˆæœŸè¨­å®šï¼šå°±è¾²æº–å‚™å¹´æ•°3å¹´+å†æ”¯æ´é–‹å§‹1å¹´ã®4å¹´)ã®å¯¾è±¡è€…ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="configSection" class="card no-print" style="display:none;">
                <h3>2. é …ç›®ã®è¡¨ç¤ºè¨­å®š</h3>
                <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">
                    ä¸‹ã®è¡¨ã§ã€è¦‹å‡ºã—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’ãƒã‚¦ã‚¹ã§<strong>å·¦å³ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong>ã™ã‚‹ã¨é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚<br>
                    ã“ã“ã®å…¥åŠ›æ¬„ã®æ•°å­—ã‚‚é€£å‹•ã—ã¦å¤‰ã‚ã‚Šã¾ã™ã€‚
                </p>

                <div class="config-save-area">
                    <span style="font-weight: bold;">è¨­å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼š</span>
                    <button class="btn btn-sm btn-warning"
                        onclick="document.getElementById('configFileInput').click()">ğŸ“‚ è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
                    <button class="btn btn-sm btn-success" onclick="exportConfigToFile()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                    <button class="btn btn-sm" style="background: #ef4444; color: white;" onclick="resetConfig()">ğŸ”„
                        ãƒªã‚»ãƒƒãƒˆ</button>
                    <input type="file" id="configFileInput" style="display:none" accept=".json"
                        onchange="importConfigFromFile(event)">
                </div>

                <div id="headerSettings" class="config-grid"></div>
                <div class="btn-group no-print" style="margin-bottom: 15px;">
                    <button class="btn btn-info" onclick="toggleTextPreview('csv')">CSVã®ä¸­èº«ã‚’ç¢ºèª</button>
                    <button class="btn btn-success" onclick="exportCSV()">CSVä¿å­˜</button>
                    <button class="btn btn-warning" onclick="exportJSON()">JSONä¿å­˜</button>
                    <button class="btn btn-primary" onclick="window.print()">å°åˆ· / PDFå‡ºåŠ›</button>
                    <div class="font-size-control">
                        <label for="fontSizeSlider">ãƒ•ã‚©ãƒ³ãƒˆ:</label>
                        <input type="range" id="fontSizeSlider" min="0.7" max="1.3" step="0.05" value="0.9"
                            oninput="changeFontSize(this.value)">
                        <span class="font-size-display" id="fontSizeDisplay">0.9rem</span>
                    </div>
                    <div class="font-size-control">
                        <label>å°åˆ·æ–¹å‘:</label>
                        <label style="font-weight: normal; cursor: pointer; margin-left: 5px;"><input type="radio"
                                name="print_orient" value="portrait" onchange="changeOrientation('portrait')"> ç¸¦</label>
                        <label style="font-weight: normal; cursor: pointer; margin-left: 5px;"><input type="radio"
                                name="print_orient" value="landscape" checked onchange="changeOrientation('landscape')">
                            æ¨ª</label>
                    </div>
                </div>
            </div>
        </div><!-- /#panelArea -->

        <div class="card no-print">
            <h3>3. è¡¨é¡Œï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã‚’æ±ºã‚ã‚‹</h3>
            <input type="text" id="tableTitle" placeholder="ä¾‹ï¼šæœˆé–“ã¾ã¨ã‚"
                style="width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid var(--border); border-radius: 4px;"
                oninput="renderTable()">
        </div>

        <div class="card">
            <div id="dataTextPreview" class="data-text-preview no-print">
                <strong id="previewType"></strong>ã®ä¸­èº«ï¼š
                <textarea id="dataTextOutput" readonly></textarea>
            </div>

            <div id="displayTitle" class="preview-title"></div>
            <div class="table-wrapper" id="tableWrapper">
                <div id="tablePreview"></div>
            </div>
        </div>
    </div>

    <style id="printStyles"></style>

    <script>
        const IDB_NAME = 'TableMakerDX';
        const IDB_STORE = 'state';
        const IDB_KEY = 'app';

        let rawRecords = [];
        let headerConfigs = [];
        let stats = { total: 0, fullDup: 0, unique: 0 };
        let columnWidths = {};
        let currentFontSize = 0.9;
        let printOrientation = 'landscape';
        let draggedColIndex = null;
        let panelVisible = true;

        function togglePanelVisibility() {
            panelVisible = !panelVisible;
            const el = document.getElementById('panelArea');
            const btn = document.getElementById('togglePanelBtn');
            if (panelVisible) {
                el.style.display = '';
                btn.textContent = 'â–¼ æ“ä½œãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º';
            } else {
                el.style.display = 'none';
                btn.textContent = 'â–¶ æ“ä½œãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º';
            }
        }

        function initializeDefaultDateLimit() {
            setToToday();
        }

        function setToToday() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            const defaultDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById('latestDateLimit').value = defaultDate;
            if (rawRecords.length > 0) renderTable();
        }

        function openIDB() {
            return new Promise((resolve, reject) => {
                const r = indexedDB.open(IDB_NAME, 1);
                r.onerror = () => reject(r.error);
                r.onsuccess = () => resolve(r.result);
                r.onupgradeneeded = (e) => { e.target.result.createObjectStore(IDB_STORE); };
            });
        }

        function saveToIndexedDB() {
            openIDB().then(db => {
                const state = {
                    csvInput: document.getElementById('csvInput').value,
                    tableTitle: document.getElementById('tableTitle').value,
                    latestDateLimit: document.getElementById('latestDateLimit').value,
                    backwardYearsZ: document.getElementById('backwardYearsZ').value,
                    enableDedup: document.getElementById('enableDedup').checked,
                    currentFontSize,
                    printOrientation,
                    headerConfigs,
                    columnWidths
                };
                const tx = db.transaction(IDB_STORE, 'readwrite');
                tx.objectStore(IDB_STORE).put(state, IDB_KEY);
                db.close();
            }).catch(() => { });
        }

        function loadFromIndexedDB() {
            openIDB().then(db => {
                const tx = db.transaction(IDB_STORE, 'readonly');
                const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
                req.onsuccess = () => {
                    const state = req.result;
                    if (!state) { db.close(); return; }
                    document.getElementById('csvInput').value = state.csvInput || '';
                    document.getElementById('tableTitle').value = state.tableTitle || '';
                    if (state.latestDateLimit) document.getElementById('latestDateLimit').value = state.latestDateLimit;
                    if (state.backwardYearsZ) document.getElementById('backwardYearsZ').value = state.backwardYearsZ;
                    if (typeof state.enableDedup === 'boolean') document.getElementById('enableDedup').checked = state.enableDedup;
                    if (state.currentFontSize) {
                        currentFontSize = state.currentFontSize;
                        document.getElementById('fontSizeSlider').value = currentFontSize;
                        document.getElementById('fontSizeDisplay').textContent = currentFontSize + 'rem';
                    }
                    if (state.printOrientation) {
                        printOrientation = state.printOrientation;
                        const radios = document.getElementsByName('print_orient');
                        radios.forEach(r => { if (r.value === printOrientation) r.checked = true; });
                    }
                    if (state.headerConfigs && state.headerConfigs.length) headerConfigs = state.headerConfigs;
                    if (state.columnWidths && Object.keys(state.columnWidths).length) columnWidths = state.columnWidths;
                    if (document.getElementById('csvInput').value.trim()) processData();
                    else {
                        renderHeaderConfigUI();
                        if (headerConfigs.length) document.getElementById('configSection').style.display = 'block';
                        renderTable();
                    }
                    db.close();
                };
                req.onerror = () => db.close();
            }).catch(() => { });
        }

        function clearIndexedDB() {
            if (!confirm('IndexedDBã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            openIDB().then(db => {
                const tx = db.transaction(IDB_STORE, 'readwrite');
                tx.objectStore(IDB_STORE).delete(IDB_KEY);
                tx.oncomplete = () => {
                    db.close();
                    alert('IndexedDBã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
                    location.reload();
                };
            }).catch(() => alert('ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
        }

        let saveIDBTimeout;
        function scheduleSaveIDB() {
            clearTimeout(saveIDBTimeout);
            saveIDBTimeout = setTimeout(saveToIndexedDB, 500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDefaultDateLimit();
            loadFromIndexedDB();
        });

        // å’Œæš¦ï¼ˆR, H, Sï¼‰ã‚’è¥¿æš¦ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function parseJapaneseDate(dateStr) {
            if (!dateStr) return null;

            let s = dateStr.trim();

            // å’Œæš¦ï¼ˆR7.10.23 ãªã©ï¼‰ã®å ´åˆ
            const eraRegex = /^([RHSTM])(\d+)[\./](\d{1,2})[\./](\d{1,2})$/;
            const match = s.match(eraRegex);

            if (match) {
                const eras = { 'R': 2018, 'H': 1988, 'S': 1925, 'T': 1911, 'M': 1867 };
                const eraChar = match[1];
                const eraYear = parseInt(match[2]);
                const month = match[3];
                const day = match[4];

                if (eras[eraChar]) {
                    const westernYear = eraYear + eras[eraChar];
                    return new Date(`${westernYear}/${month}/${day}`);
                }
            }

            // è¥¿æš¦ï¼ˆ2025/10/23 ãªã©ï¼‰ã®å ´åˆ
            const westernRegex = /^(\d{4})[\./](\d{1,2})[\./](\d{1,2})$/;
            const westMatch = s.match(westernRegex);

            if (westMatch) {
                return new Date(`${westMatch[1]}/${westMatch[2]}/${westMatch[3]}`);
            }

            // ãã®ä»–ã®å½¢å¼ã¯é€šå¸¸ã®Dateã§è©¦ã™
            return new Date(s);
        }

        function changeFontSize(size) {
            currentFontSize = parseFloat(size);
            document.getElementById('fontSizeDisplay').textContent = currentFontSize + 'rem';

            document.querySelectorAll('table th, table td').forEach(el => {
                el.style.fontSize = currentFontSize + 'rem';
            });

            generatePrintStyles();
            scheduleSaveIDB();
        }

        function changeOrientation(orient) {
            printOrientation = orient;
            generatePrintStyles();
            scheduleSaveIDB();
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('csvInput').value = event.target.result;
                processData();
            };
            reader.readAsText(file);
        }

        function processData() {
            const text = document.getElementById('csvInput').value.trim();
            if (!text) return;

            const lines = text.split('\n').filter(l => l.trim() !== "");
            stats.total = lines.length;

            const uniqueLines = [...new Set(lines)];
            stats.fullDup = stats.total - uniqueLines.length;

            const isDedup = document.getElementById('enableDedup').checked;
            const itemSet = new Set();
            const tempRecords = [];

            uniqueLines.forEach(line => {
                const cols = line.split(/,|\t/).map(s => s.trim().replace(/^"|"$/g, ''));
                if (cols.length < 4) return;

                itemSet.add(cols[2]);

                const parsedDate = parseJapaneseDate(cols[0]);
                const timestamp = (parsedDate && !isNaN(parsedDate)) ? parsedDate.getTime() : 0;

                tempRecords.push({
                    date: cols[0],
                    name: cols[1],
                    item: cols[2],
                    content: cols[3],
                    ts: timestamp
                });
            });

            const map = new Map();

            tempRecords.forEach(r => {
                // ã‚­ãƒ¼ï¼šã€Œåå‰ | é …ç›® | å†…å®¹ã€ï¼ˆæ—¥ä»˜ã¯å«ã‚ãªã„ï¼‰
                const key = `${r.name}|${r.item}|${r.content}`;

                if (!map.has(key)) {
                    map.set(key, r);
                } else {
                    const existing = map.get(key);

                    if (isDedup) {
                        if (r.ts < existing.ts) {
                            map.set(key, r);
                        }
                    }
                }
            });

            if (isDedup) {
                rawRecords = Array.from(map.values());
            } else {
                rawRecords = tempRecords;
            }

            stats.unique = rawRecords.length;

            if (headerConfigs.length === 0) {
                headerConfigs = [
                    {
                        raw: '__NAME__',
                        sourceName: 'åå‰ï¼ˆå¯¾è±¡ï¼‰',
                        displayName: 'åå‰ï¼ˆå¯¾è±¡ï¼‰',
                        order: 0,
                        mode: 'content',
                        fDate: '',
                        fFreq: 1,
                        fContent: '',
                        isNameColumn: true
                    },
                    {
                        raw: '__AGE__',
                        sourceName: 'å¹´é½¢ (è¨ˆç®—)',
                        displayName: 'å¹´é½¢',
                        order: 0,
                        mode: 'content',
                        fDate: '',
                        fFreq: 1,
                        fContent: '',
                        isNameColumn: false
                    }
                ];

                Array.from(itemSet).forEach((item, i) => {
                    headerConfigs.push({
                        raw: item,
                        sourceName: item,
                        displayName: item,
                        order: 0,
                        mode: 'content',
                        fDate: '',
                        fFreq: 1,
                        fContent: '',
                        isNameColumn: false
                    });
                });
                columnWidths = {};
            } else {
                // æ—¢å­˜è¨­å®šãŒã‚ã‚‹å ´åˆã§ã‚‚ä»®æƒ³ã‚«ãƒ©ãƒ ã‚’è£œå®Œ
                if (!headerConfigs.find(c => c.raw === '__NAME__')) {
                    headerConfigs.unshift({
                        raw: '__NAME__', sourceName: 'åå‰ï¼ˆå¯¾è±¡ï¼‰', displayName: 'åå‰ï¼ˆå¯¾è±¡ï¼‰',
                        order: 0, mode: 'content', fDate: '', fFreq: 1, fContent: '', isNameColumn: true
                    });
                }
                if (!headerConfigs.find(c => c.raw === '__AGE__')) {
                    const nameIdx = headerConfigs.findIndex(c => c.raw === '__NAME__');
                    headerConfigs.splice(nameIdx + 1, 0, {
                        raw: '__AGE__', sourceName: 'å¹´é½¢ (è¨ˆç®—)', displayName: 'å¹´é½¢',
                        order: 0, mode: 'content', fDate: '', fFreq: 1, fContent: '', isNameColumn: false
                    });
                }

                // æ–°ã—ã„é …ç›®ï¼ˆCSVã«æ–°ã—ãå‡ºç¾ã—ãŸé …ç›®ï¼‰ãŒã‚ã‚Œã°è¿½åŠ 
                Array.from(itemSet).forEach(item => {
                    if (!headerConfigs.find(c => c.raw === item)) {
                        headerConfigs.push({
                            raw: item, sourceName: item, displayName: item,
                            order: 0, mode: 'content', fDate: '', fFreq: 1, fContent: '', isNameColumn: false
                        });
                    }
                });
            }

            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('configSection').style.display = 'block';

            if (document.getElementById('rawJsonPreviewArea').style.display === 'block') {
                updateRawJsonPreview();
            }

            renderHeaderConfigUI();
            renderTable();
            scheduleSaveIDB();
        }

        function updateRawJsonPreview() {
            const grouped = {};
            rawRecords.forEach(r => {
                if (!grouped[r.name]) grouped[r.name] = [];
                grouped[r.name].push({
                    date: r.date,
                    item: r.item,
                    content: r.content
                });
            });
            document.getElementById('rawJsonOutput').value = JSON.stringify(grouped, null, 2);
        }

        function toggleRawJsonPreview() {
            const area = document.getElementById('rawJsonPreviewArea');

            if (area.style.display === 'none') {
                if (rawRecords.length === 0) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }
                updateRawJsonPreview();
                area.style.display = 'block';
            } else {
                area.style.display = 'none';
            }
        }

        function renderHeaderConfigUI() {
            const container = document.getElementById('headerSettings');
            container.innerHTML = headerConfigs.map((config, i) => `
        <div class="header-item-card ${config.isNameColumn ? 'name-card' : ''}">
            <div class="source-name">${config.sourceName}</div>
            <div class="input-row">
                <label>è¡¨ã§ã®é …ç›®å</label>
                <input type="text" value="${config.displayName}" oninput="headerConfigs[${i}].displayName=this.value; renderTable()">
            </div>
            <div class="input-row">
                <label>è¡¨ç¤ºé †åº</label>
                <input type="number" value="${config.order === 0 ? '' : config.order}" placeholder="1, 2, 3..." onchange="headerConfigs[${i}].order = parseInt(this.value) || 0; renderTable()">
            </div>
            <div class="mode-radio">
                <label><input type="radio" name="m_${i}" value="content" ${config.mode === 'content' ? 'checked' : ''} onchange="headerConfigs[${i}].mode='content'; renderTable()"> å†…å®¹</label>
                <label><input type="radio" name="m_${i}" value="date" ${config.mode === 'date' ? 'checked' : ''} onchange="headerConfigs[${i}].mode='date'; renderTable()"> æ—¥ä»˜</label>
                <label><input type="radio" name="m_${i}" value="freq" ${config.mode === 'freq' ? 'checked' : ''} onchange="headerConfigs[${i}].mode='freq'; renderTable()"> é »åº¦</label>
            </div>
            <div class="column-filters">
                <div><span>æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿</span><input type="text" value="${config.fDate}" placeholder="2025/01" oninput="headerConfigs[${i}].fDate=this.value; renderTable()"></div>
                <div><span>é »åº¦(ä»¥ä¸Š)</span><input type="number" value="${config.fFreq}" min="1" oninput="headerConfigs[${i}].fFreq=parseInt(this.value); renderTable()"></div>
                <div><span>å†…å®¹ãƒ•ã‚£ãƒ«ã‚¿</span><input type="text" value="${config.fContent}" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" oninput="headerConfigs[${i}].fContent=this.value; renderTable()"></div>
            </div>
        </div>
    `).join('');
        }

        function exportConfigToFile() {
            try {
                const configData = JSON.stringify(headerConfigs, null, 2);
                const blob = new Blob([configData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `è¨­å®š_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (error) {
                alert('âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function importConfigFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const configData = JSON.parse(e.target.result);
                    if (Array.isArray(configData)) {
                        headerConfigs = configData;
                        renderHeaderConfigUI();
                        renderTable();
                        scheduleSaveIDB();
                        alert('âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
                    } else {
                        alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                    }
                } catch (error) {
                    alert('âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
            document.getElementById('configFileInput').value = '';
        }

        function resetConfig() {
            if (confirm('âš ï¸ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                headerConfigs.forEach(config => {
                    config.order = 0;
                });
                columnWidths = {};
                renderHeaderConfigUI();
                renderTable();
                scheduleSaveIDB();
                alert('âœ… é …ç›®ã®é †ç•ªã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼');
            }
        }

        function getTableData() {
            const activeConfigs = headerConfigs.filter(c => c.order > 0).sort((a, b) => a.order - b.order);
            const dateLimitValue = document.getElementById('latestDateLimit').value;
            const dateLimitTs = dateLimitValue ? new Date(dateLimitValue + 'T00:00:00').getTime() : 0;
            const zYears = parseInt(document.getElementById('backwardYearsZ').value) || 2;

            const grouped = {};
            rawRecords.forEach(r => {
                if (!grouped[r.name]) grouped[r.name] = { items: {}, maxTs: 0, shinukiShunoTs: null };
                if (!grouped[r.name].items[r.item]) grouped[r.name].items[r.item] = [];
                grouped[r.name].items[r.item].push(r);
                if (r.ts > grouped[r.name].maxTs) grouped[r.name].maxTs = r.ts;

                // æ–°è¦å°±è¾²ã®æ—¥ä»˜ã‚’è¿½è·¡
                if (r.item === 'é’å¹´ç­‰å°±è¾²è¨ˆç”»æ¨é€²ä¼šè­°' && r.content === 'æ–°è¦å°±è¾²') {
                    if (grouped[r.name].shinukiShunoTs === null || r.ts > grouped[r.name].shinukiShunoTs) {
                        grouped[r.name].shinukiShunoTs = r.ts;
                    }
                }
            });

            // åŸºæº–æ—¥ã‹ã‚‰Nå¹´å‰ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            const getThresholdTs = (years) => {
                const d = new Date(dateLimitTs);
                d.setFullYear(d.getFullYear() - years);
                return d.getTime();
            };

            const fiveYearsTs = getThresholdTs(5);
            const zYearsTs = getThresholdTs(zYears);

            let names = Object.keys(grouped).filter(name => {
                const data = grouped[name];
                if (data.shinukiShunoTs !== null) {
                    // ã‚±ãƒ¼ã‚¹1ï¼šæ–°è¦å°±è¾²ãŒã‚ã‚‹å ´åˆã€åŸºæº–æ—¥ã‹ã‚‰5å¹´ä»¥å†…
                    return data.shinukiShunoTs >= fiveYearsTs && data.shinukiShunoTs <= dateLimitTs;
                } else {
                    // ã‚±ãƒ¼ã‚¹2ï¼šæ–°è¦å°±è¾²ãŒãªã„å ´åˆã€æœ€æ–°ã®æ—¥ä»˜ãŒåŸºæº–æ—¥ã‹ã‚‰Zå¹´ä»¥å†…
                    return data.maxTs >= zYearsTs && data.maxTs <= dateLimitTs;
                }
            }).sort();

            const rows = names.map(name => {
                const cells = activeConfigs.map(c => {
                    if (c.raw === '__NAME__') {
                        return name;
                    }

                    if (c.raw === '__AGE__') {
                        const birthdateItems = grouped[name].items['ç”Ÿå¹´æœˆæ—¥'] || [];
                        if (birthdateItems.length === 0) return "-";

                        // æœ€æ–°ã®ã€Œç”Ÿå¹´æœˆæ—¥ã€ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        const latestBirthRecord = birthdateItems[birthdateItems.length - 1];
                        const birthDate = parseJapaneseDate(latestBirthRecord.date);
                        if (!birthDate || isNaN(birthDate)) return "-";

                        const refDate = new Date(dateLimitTs);
                        let age = refDate.getFullYear() - birthDate.getFullYear();
                        const m = refDate.getMonth() - birthDate.getMonth();
                        if (m < 0 || (m === 0 && refDate.getDate() < birthDate.getDate())) {
                            age--;
                        }
                        return age + " æ­³";
                    }

                    let items = grouped[name].items[c.raw] || [];

                    if (c.fDate) items = items.filter(it => it.date.includes(c.fDate));
                    if (c.fContent) items = items.filter(it => it.content.includes(c.fContent));
                    if (items.length === 0 || items.length < c.fFreq) return "-";

                    if (c.mode === 'freq') return items.length + " å›";
                    if (c.mode === 'date') return items[items.length - 1].date;
                    return items[items.length - 1].content;
                });
                return cells;
            });

            return { headers: activeConfigs.map(c => c.displayName), rows, configIndices: activeConfigs.map(c => headerConfigs.indexOf(c)) };
        }

        function generatePrintStyles(configIndices) {
            if (!configIndices) {
                const data = getTableData();
                configIndices = data.configIndices;
            }

            let styles = `@page { size: A4 ${printOrientation}; }\n`;
            styles += '@media print {\n';

            let totalSetWidth = 0;
            configIndices.forEach(idx => {
                totalSetWidth += columnWidths[idx] || 150;
            });

            configIndices.forEach((globalIndex, i) => {
                const width = columnWidths[globalIndex] || 150;
                const percent = (width / totalSetWidth) * 100;
                styles += `  table th:nth-child(${i + 1}), table td:nth-child(${i + 1}) { width: ${percent}% !important; box-sizing: border-box !important; }\n`;
            });

            styles += '  .table-wrapper { overflow: visible !important; }\n';
            styles += '  table { table-layout: fixed; width: 100% !important; min-width: 0 !important; max-width: 100% !important; border-collapse: collapse !important; }\n';
            styles += `  table th, table td { font-size: ${currentFontSize}rem !important; word-break: break-all; word-wrap: break-word; overflow-wrap: break-word; }\n`;
            styles += '}';
            document.getElementById('printStyles').innerText = styles;
        }

        function renderTable() {
            const { headers, rows, configIndices } = getTableData();
            document.getElementById('displayTitle').innerText = document.getElementById('tableTitle').value;

            let html = `<table><thead><tr>`;
            headers.forEach((h, i) => {
                const globalIndex = configIndices[i];
                const width = columnWidths[globalIndex] || 'auto';

                html += `<th 
            draggable="true"
            data-index="${i}" 
            ondragstart="handleDragStart(event, ${i})" 
            ondragover="handleDragOver(event)" 
            ondrop="handleDrop(event, ${i})"
            ondragleave="handleDragLeave(event)"
            style="width: ${width === 'auto' ? 'auto' : width + 'px'}; min-width: ${width === 'auto' ? '50px' : width + 'px'}; max-width: ${width === 'auto' ? 'none' : width + 'px'}; overflow: hidden; text-overflow: ellipsis; font-size: ${currentFontSize}rem;">
            ${h}
            <div class="resizer" onmousedown="startResize(event, ${globalIndex})"></div>
        </th>`;
            });
            html += `</tr></thead><tbody>`;

            rows.forEach(r => {
                html += `<tr>` + r.map((c, i) => {
                    const width = columnWidths[configIndices[i]] || 'auto';
                    return i === 0 ? `<td style="width: ${width === 'auto' ? 'auto' : width + 'px'}; min-width: ${width === 'auto' ? '50px' : width + 'px'}; max-width: ${width === 'auto' ? 'none' : width + 'px'}; overflow: hidden; text-overflow: ellipsis; font-size: ${currentFontSize}rem;"><strong>${c}</strong></td>` : `<td style="width: ${width === 'auto' ? 'auto' : width + 'px'}; min-width: ${width === 'auto' ? '50px' : width + 'px'}; max-width: ${width === 'auto' ? 'none' : width + 'px'}; overflow: hidden; text-overflow: ellipsis; font-size: ${currentFontSize}rem;">${c}</td>`;
                }).join('') + `</tr>`;
            });

            document.getElementById('tablePreview').innerHTML = html + `</tbody></table>`;

            document.getElementById('statTotal').innerText = stats.total;
            document.getElementById('statFullDup').innerText = stats.fullDup;
            document.getElementById('statUnique').innerText = stats.unique;
            document.getElementById('statFiltered').innerText = rows.length;
            document.getElementById('statTableDim').innerText = `${rows.length}ä»¶ Ã— ${headers.length}é …ç›®`;

            generatePrintStyles(configIndices);
            scheduleSaveIDB();
        }

        // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—åˆ¶å¾¡é–¢æ•° ---

        function handleDragStart(e, index) {
            if (e.target.classList.contains('resizer')) {
                e.preventDefault();
                return;
            }
            draggedColIndex = index;
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging-col');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const th = e.target.closest('th');
            if (th) {
                th.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const th = e.target.closest('th');
            if (th) {
                th.classList.remove('drag-over');
            }
        }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            const th = e.target.closest('th');
            if (th) th.classList.remove('drag-over');

            if (draggedColIndex === null || draggedColIndex === targetIndex) return;

            const activeConfigs = headerConfigs.filter(c => c.order > 0).sort((a, b) => a.order - b.order);

            const itemToMove = activeConfigs[draggedColIndex];
            activeConfigs.splice(draggedColIndex, 1);
            activeConfigs.splice(targetIndex, 0, itemToMove);

            activeConfigs.forEach((config, index) => {
                config.order = index + 1;
            });

            renderHeaderConfigUI();
            renderTable();

            draggedColIndex = null;
        }

        // ---------------------------------

        function startResize(e, colIndex) {
            e.preventDefault();
            e.stopPropagation();
            const startX = e.clientX;
            const startWidth = columnWidths[colIndex] || 100;
            const resizer = e.target;
            resizer.classList.add('dragging');

            const handleMouseMove = (moveEvent) => {
                const delta = moveEvent.clientX - startX;
                const newWidth = Math.max(30, startWidth + delta);
                columnWidths[colIndex] = newWidth;
                renderTable();
            };

            const handleMouseUp = () => {
                resizer.classList.remove('dragging');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function toggleTextPreview(format) {
            const { headers, rows } = getTableData();
            const panel = document.getElementById('dataTextPreview');
            const output = document.getElementById('dataTextOutput');
            panel.style.display = 'block';
            document.getElementById('previewType').innerText = format.toUpperCase();
            if (format === 'csv') {
                let csv = [headers.map(h => `"${h}"`).join(",")];
                rows.forEach(r => csv.push(r.map(c => `"${c}"`).join(",")));
                output.value = csv.join("\n");
            } else {
                output.value = JSON.stringify(rows.map(r => {
                    let o = {}; headers.forEach((h, i) => o[h] = r[i]); return o;
                }), null, 2);
            }
        }

        function exportCSV() {
            toggleTextPreview('csv');
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), document.getElementById('dataTextOutput').value], { type: 'text/csv' });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "é›†è¨ˆçµæœ.csv"; a.click();
        }

        function exportJSON() {
            toggleTextPreview('json');
            const blob = new Blob([document.getElementById('dataTextOutput').value], { type: 'application/json' });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "ãƒ‡ãƒ¼ã‚¿.json"; a.click();
        }
    </script>
</body>

</html>